---
layout: post
title: C语言基础知识
categories: C语言 
tags: C语言

---

## malloc_trim()函数

介绍这个函数之前首先需要介绍一下，操作系统内存分配的一些知识。

一个程序会通过malloc等函数从操作系统申请内存，放在堆上，然后通过free来释放内存。但是实际上操作系统会做个骚操作，当程序用了free之后，也不会立马把内存收走，因为他预判你以后可能还会用，如果收走了再分配很消耗性能，所以他有时候会偷偷留着一部分内存。

这时我们就需要用到malloc_trim()函数来告诉操作系统，我确实需要你释放内存，不要保留了。

通常的用法是malloc_trim(0)，表示操作系统，能释放就尽量释放吧。

详细的用法参考：[malloc_trim](https://linux.die.net/man/3/malloc_trim)



static和全局变量详解：

生存周期：从程序开始到程序结束。

初始化：

C和C++不同

C:

|        | 全局变量 | 文件域的静态变量 | 局部静态变量 |
| ------ | -------- | ---------------- | ------------ |
| 初始化 | 编译时   | 编译时           | 编译时       |

C语言的[静态变量](https://so.csdn.net/so/search?q=静态变量&spm=1001.2101.3001.7020)的初始值都是在编译完成后，就会保存在编译生成的可执行文件中。所以，初始值在编译时就要计算出来，因此C语言之中无法使用变量对静态变量进行初始化，即以下写法是无法编译通过的：

```
int a = 10;
int b = a;
int main()
{

}
```

C++:

|        | 全局变量   | 文件域的静态变量 | 类的静态成员变量 | 静态局部变量       |
| ------ | ---------- | ---------------- | ---------------- | ------------------ |
| 初始化 | main执行前 | main执行前       | main执行前       | 首次执行相关代码时 |

main执行前是指：

全局变量、文件域的静态变量和类的静态成员变量在main执行之前的**静态初始化过程**中分配内存并初始化；静态局部变量（一般为函数内的静态变量）在第一次使用时分配内存并初始化。这里的变量包含内置数据类型和自定义类型的对象

静态初始化是指：

从语言的层面来说，全局变量的初始化可以划分为以下两个阶段：

static initialization: **静态初始化指的是用常量来对变量进行初始化**,主要包括 zero initialization 和 const initialization，静态初始化在程序加载的过程中完成，对简单类型(内建类型，POD等)来说，从具体实现上看，zero initialization 的变量会被保存在 bss 段，const initialization 的变量则放在 data 段内，程序加载即可完成初始化，这和 c 语言里的全局变量初始化基本是一致的。

dynamic initialization：**动态初始化主要是指需要经过函数调用才能完成的初始化**，比如说：int a = foo()，或者是复杂类型（类）的初始化（需要调用构造函数）等。这些变量的初始化会在 main 函数执行前由运行时调用相应的代码从而得以进行(静态局部变量除外)。这里没太懂啥时候会动态初始化



so1链接了so2，so2也可以使用so1中的符号

因为插件其实也是一个so，插件1加载了插件2，也就是2是1的子插件，2也可以随便用1中的符号。所以子插件可以用父插件中的符号。



c++编译后会把函数名变成类似这样的_ZN6CRwIni9GetStringEPKcS1_PciS1_，可以通过`c++filter ZN6CRwIni9GetStringEPKcS1_PciS1`命令看到具体是哪个函数。

也可以ldd -r xxx.so来看so链接的情况，以及这个so中有哪些符号未定义



全局变量或函数是否能放到头文件中定义：

1.全局变量不能 。全局变量必须全局唯一，因为多个cpp都会包含这个头文件，导致一个有多个地方定义这个变量，编译时会报重定义的错误

2.static静态变量根据情况而定。只能在当前文件中可见，所以放到头文件中之后，任何包含这个头文件的cpp都会定义一次这个静态变量。如果这是你要的效果的话倒可以放到头文件里。